# Data Wrangling

We will mostly be using the `tidyr` and `dplyr` packages for wrangling. With those packages, most wrangling is done with 6 "data verbs." These are `select()`, `mutate()`, `filter()`, `arrange()`, `group_by()`, and `summarise()`. One quick note: summarise can be spelled the British or American way (as can any word with dual spellings). Much of the software was developed by people in New Zealand, hence the British spellings. I learned with British spellings so that's what I use, but it works either way. 

```{r echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/rstats-artwork/dplyr_wrangling.png")
```



We can divide our verbs into 3 categories: row verbs, column verbs, and aggregate verbs. 

All of the verbs work in a similar way. The general structure is `verb(data, action)`.

## Row verbs

The two row verbs are `filter()` and `arrange()`. Filter works by taking out rows that we don't want in our data. Arrange works by ordering the rows in some way. We will talk about filter first.

### Filter

Filter takes in boolean statements and returns only the `TRUE` ones. For example, `>`, `<`, and `==` are boolean statements. The double equal is R's way of saying something "is equivalent to."

Let's start by creating a dataframe of only Saturday trips.

```{r}
# create a new dataframe called weekend_trips

saturday_trips <- filter(nice_ride_2018, start_day == "Sat") 

dim(saturday_trips) # check that you have these dimensions
```

We can also make a dataframe of trips that ended after 12 noon.

```{r}
after_12 <- filter(nice_ride_2018, end_hour > 12) 

dim(after_12)
```

Let's say we want some combination of filters. Maybe we want only the Saturday trips that ended after noon? We will use the `&` operator in between filter actions.

```{r}
saturday_after_12 <- filter(nice_ride_2018, end_hour > 12 & start_day == "Sat")

dim(saturday_after_12)
```

Now let's make a dataframe of all the trips on a weekend day. We will use the `|` (or) operator in between filter actions. 

```{r}
weekend_trips <- filter(nice_ride_2018, start_day == "Sat" | start_day == "Sun")

dim(weekend_trips)
```

Let's add Friday to that list.

```{r}
weekendFri_trips <- filter(nice_ride_2018, start_day == "Sat" | start_day == "Sun" | start_day == "Fri")

dim(weekendFri_trips)
```

It gets a little long to write that all out, and this is a pretty simply query. Luckily, R has an `%in%` operator to filter "in bulk."

We would get the same results as above by writing:

```{r}
weekendFri_trips <- filter(nice_ride_2018, start_day %in% c("Sat", "Sun", "Fri"))

dim(weekendFri_trips)
```

### Arrange

Arrange is a way to order your dataset by specific variables. 

You can order by just one variable, like duration. 



## Practice

1. How many trips were more than 30 minutes long? This is equivalent to 1800 seconds. 

2 (a). How many casual trips were there on Wednesdays, Thursdays, and Fridays?

2 (b) . How many casual trips were there on Wednesdays, Thursdays, and Fridays that were 15 minutes or less?

3. How many dockless trips taken by subscribed users were there total? 

## Column verbs

Now that we've talked about wrangling the rows, we can think about wrangling the columns. `mutate` is used to create new columns, while `select` is used to narrow down the columns you keep in your table. 

### Mutate

```{r echo = FALSE, caption = "Artwork by Allison Horst"}
knitr::include_graphics("images/dplyr_mutate.png")
```

Let's say we want to create a new duration variable that is in minutes instead of seconds. We can divide our old column by 60 to create the new column.

```{r}
nice_ride_2018 <- mutate(nice_ride_2018, tripduration_min = tripduration / 60)

head(nice_ride_2018$tripduration_min)
```

## Practice

The average trip duration in minutes is 21.257 (see code below).

```{r}
summary(nice_ride_2018$tripduration_min)
```

Create a new variation called duration_deviation that calculates how far each trip was from the mean. 

```{r echo = FALSE}
nice_ride_2018 %>%
  mutate(duration_deviation = tripduration_min - 21.257) %>%
  select(duration_deviation) %>%
  head()
```


## Aggregate verbs

## Practice

1. Calculate the number of trips for each user type occurred at each start station. The structure should look like the example below:

```{r echo = FALSE}
nice_ride_2018 %>%
  group_by(start_station_name, usertype) %>%
  summarise(trips = n()) %>%
  head()
```


## Reshaping verbs

### Spread

```{r echo = FALSE}
knitr::include_graphics("https://garrettgman.github.io/images/tidy-8.png")
```


### Gather

```{r echo = FALSE}
knitr::include_graphics("https://garrettgman.github.io/images/tidy-9.png")
```

## Practice